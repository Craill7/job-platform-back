<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.sysu.sse.recruitment.job_platform_api.server.mapper.LocationMapper">

    <!-- 省份结果映射 -->
    <resultMap id="ProvinceResultMap" type="cn.sysu.sse.recruitment.job_platform_api.pojo.entity.Province">
        <id column="id" property="id"/>
        <result column="code" property="code"/>
        <result column="name" property="name"/>
    </resultMap>

    <!-- 城市结果映射 -->
    <resultMap id="CityResultMap" type="cn.sysu.sse.recruitment.job_platform_api.pojo.entity.City">
        <id column="id" property="id"/>
        <result column="province_id" property="provinceId"/>
        <result column="code" property="code"/>
        <result column="name" property="name"/>
    </resultMap>

    <!-- 获取所有省份 -->
    <select id="findAllProvinces" resultMap="ProvinceResultMap">
        SELECT id, code, name
        FROM t_provinces
        ORDER BY id
    </select>

    <!-- 根据省份ID获取城市列表 -->
    <select id="findCitiesByProvinceId" parameterType="java.lang.Integer" resultMap="CityResultMap">
        SELECT id, province_id, code, name
        FROM t_cities
        WHERE province_id = #{provinceId}
        ORDER BY id
    </select>

    <!-- 根据关键字匹配省份（名称/代码，模糊匹配名称） -->
    <select id="findProvinceByKeyword" parameterType="java.lang.String" resultMap="ProvinceResultMap">
        SELECT id, code, name
        FROM t_provinces
        WHERE name LIKE CONCAT('%', #{keyword}, '%')
           OR code = #{keyword}
        ORDER BY CHAR_LENGTH(name) ASC
        LIMIT 1
    </select>

    <!-- 根据关键字匹配城市，可选限定省份 -->
    <select id="findCityByKeyword" resultMap="CityResultMap">
        SELECT id, province_id, code, name
        FROM t_cities
        WHERE (name LIKE CONCAT('%', #{keyword}, '%') OR code = #{keyword})
        <if test="provinceId != null">
            AND province_id = #{provinceId}
        </if>
        ORDER BY CHAR_LENGTH(name) ASC
        LIMIT 1
    </select>

	<select id="findProvincesByIds" parameterType="java.util.List" resultMap="ProvinceResultMap">
		SELECT id, code, name
		FROM t_provinces
		WHERE id IN
		<foreach collection="ids" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</select>

	<select id="findCitiesByIds" parameterType="java.util.List" resultMap="CityResultMap">
		SELECT id, province_id, code, name
		FROM t_cities
		WHERE id IN
		<foreach collection="ids" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</select>

</mapper>
