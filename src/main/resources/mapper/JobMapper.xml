<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.sysu.sse.recruitment.job_platform_api.server.mapper.JobMapper">
	<resultMap id="JobMap" type="cn.sysu.sse.recruitment.job_platform_api.pojo.entity.Job">
		<id column="id" property="id"/>
		<result column="company_id" property="companyId"/>
		<result column="posted_by_user_id" property="postedByUserId"/>
		<result column="title" property="title"/>
		<result column="description" property="description"/>
		<result column="tech_requirements" property="techRequirements"/>
		<result column="min_salary" property="minSalary"/>
		<result column="max_salary" property="maxSalary"/>
		<result column="province_id" property="provinceId"/>
		<result column="city_id" property="cityId"/>
		<result column="address_detail" property="addressDetail"/>
		<result column="work_nature" property="workNature" javaType="cn.sysu.sse.recruitment.job_platform_api.common.enums.WorkNature"/>
		<result column="deadline" property="deadline"/>
		<result column="status" property="status" javaType="cn.sysu.sse.recruitment.job_platform_api.common.enums.JobStatus"/>
		<result column="created_at" property="createdAt"/>
		<result column="updated_at" property="updatedAt"/>
		<result column="type" property="type"/>
		<result column="department" property="department"/>
		<result column="headcount" property="headcount"/>
		<result column="required_degree" property="requiredDegree"/>
		<result column="required_start_date" property="requiredStartDate"/>
		<result column="bonus_points" property="bonusPoints"/>
		<result column="work_address" property="workAddress"/>
	</resultMap>

	<insert id="insert" parameterType="cn.sysu.sse.recruitment.job_platform_api.pojo.entity.Job" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO jobs
		(company_id, posted_by_user_id, title, description, tech_requirements, min_salary, max_salary, province_id, city_id, address_detail, work_nature, deadline, status, created_at, updated_at, type, department, headcount, required_degree, required_start_date, bonus_points, work_address)
		VALUES
		(#{companyId}, #{postedByUserId}, #{title}, #{description}, #{techRequirements}, #{minSalary}, #{maxSalary}, #{provinceId}, #{cityId}, #{addressDetail}, #{workNature}, #{deadline}, #{status}, NOW(), NOW(), #{type}, #{department}, #{headcount}, #{requiredDegree}, #{requiredStartDate}, #{bonusPoints}, #{workAddress})
	</insert>

	<update id="update" parameterType="cn.sysu.sse.recruitment.job_platform_api.pojo.entity.Job">
		UPDATE jobs
		SET
			title = #{title},
			description = #{description},
			tech_requirements = #{techRequirements},
			min_salary = #{minSalary},
			max_salary = #{maxSalary},
			province_id = #{provinceId},
			city_id = #{cityId},
			address_detail = #{addressDetail},
			work_nature = #{workNature},
			deadline = #{deadline},
			status = #{status},
			updated_at = NOW(),
			type = #{type},
			department = #{department},
			headcount = #{headcount},
			required_degree = #{requiredDegree},
			required_start_date = #{requiredStartDate},
			bonus_points = #{bonusPoints},
			work_address = #{workAddress}
		WHERE id = #{id}
	</update>

	<delete id="deleteById">
		DELETE FROM jobs WHERE id = #{id}
	</delete>

	<select id="findById" resultMap="JobMap">
		SELECT * FROM jobs WHERE id = #{id}
	</select>

	<select id="findByIdAndCompany" resultMap="JobMap">
		SELECT * FROM jobs WHERE id = #{id} AND company_id = #{companyId}
	</select>

	<select id="countApprovedJobsByCompany" resultType="long">
		SELECT COUNT(1) FROM jobs WHERE company_id = #{companyId} AND status = 20
	</select>

	<select id="listByCompany" resultMap="JobMap">
		SELECT * FROM jobs
		WHERE company_id = #{companyId}
		ORDER BY updated_at DESC, id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<select id="countByCompany" resultType="long">
		SELECT COUNT(1) FROM jobs WHERE company_id = #{companyId}
	</select>

	<select id="searchCompanyJobs" resultType="cn.sysu.sse.recruitment.job_platform_api.pojo.dto.JobWithStatsDTO">
		SELECT
			j.id AS jobId,
			j.title,
			j.work_nature AS workNature,
			j.status,
			j.updated_at AS updatedAt,
			COALESCE(total_stats.received_num, 0) AS receivedNum,
			COALESCE(no_review_stats.no_review_num, 0) AS noReviewNum
		FROM jobs j
		LEFT JOIN (
			SELECT job_id, COUNT(1) AS received_num
			FROM applications
			GROUP BY job_id
		) total_stats ON total_stats.job_id = j.id
		LEFT JOIN (
			SELECT job_id, COUNT(1) AS no_review_num
			FROM applications
			WHERE status = 10
			GROUP BY job_id
		) no_review_stats ON no_review_stats.job_id = j.id
		WHERE j.company_id = #{companyId}
		<if test="titleKeyword != null and titleKeyword != ''">
			AND j.title LIKE CONCAT('%', #{titleKeyword}, '%')
		</if>
		<if test="workNature != null">
			AND j.work_nature = #{workNature}
		</if>
		<if test="status != null">
			AND j.status = #{status}
		</if>
		ORDER BY j.updated_at DESC, j.id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<select id="countCompanyJobs" resultType="long">
		SELECT COUNT(1)
		FROM jobs j
		WHERE j.company_id = #{companyId}
		<if test="titleKeyword != null and titleKeyword != ''">
			AND j.title LIKE CONCAT('%', #{titleKeyword}, '%')
		</if>
		<if test="workNature != null">
			AND j.work_nature = #{workNature}
		</if>
		<if test="status != null">
			AND j.status = #{status}
		</if>
	</select>

	<!-- 求职中心相关查询 -->
	<select id="searchJobs" resultMap="JobMap">
		SELECT DISTINCT j.*
		FROM jobs j
		LEFT JOIN companies c ON j.company_id = c.company_id
		LEFT JOIN job_tags jt ON j.id = jt.job_id
		WHERE j.status = 20
		<if test="keyword != null and keyword != ''">
			AND (j.title LIKE CONCAT('%', #{keyword}, '%') OR c.company_name LIKE CONCAT('%', #{keyword}, '%'))
		</if>
		<if test="location != null and location != ''">
			AND j.address_detail LIKE CONCAT('%', #{location}, '%')
		</if>
		<if test="type != null and type != ''">
			AND j.type = #{type}
		</if>
		<if test="tagIds != null and tagIds.size() > 0">
			AND jt.tag_id IN
			<foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
				#{tagId}
			</foreach>
		</if>
		<if test="workNature != null and workNature != ''">
			AND j.work_nature = #{workNature}
		</if>
		ORDER BY j.updated_at DESC, j.id DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<select id="countSearchJobs" resultType="long">
		SELECT COUNT(DISTINCT j.id)
		FROM jobs j
		LEFT JOIN companies c ON j.company_id = c.company_id
		LEFT JOIN job_tags jt ON j.id = jt.job_id
		WHERE j.status = 20
		<if test="keyword != null and keyword != ''">
			AND (j.title LIKE CONCAT('%', #{keyword}, '%') OR c.company_name LIKE CONCAT('%', #{keyword}, '%'))
		</if>
		<if test="location != null and location != ''">
			AND j.location LIKE CONCAT('%', #{location}, '%')
		</if>
		<if test="type != null and type != ''">
			AND j.type = #{type}
		</if>
		<if test="tagIds != null and tagIds.size() > 0">
			AND jt.tag_id IN
			<foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
				#{tagId}
			</foreach>
		</if>
		<if test="workNature != null and workNature != ''">
			AND j.work_nature = #{workNature}
		</if>
	</select>

	<select id="findFavoriteJobsByStudent" resultMap="JobMap">
		SELECT j.*
		FROM jobs j
		INNER JOIN job_favorites jf ON j.id = jf.job_id
		WHERE jf.student_user_id = #{studentUserId}
		AND j.status = 20
		ORDER BY jf.saved_at DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>

	<select id="countFavoriteJobsByStudent" resultType="long">
		SELECT COUNT(1)
		FROM jobs j
		INNER JOIN job_favorites jf ON j.id = jf.job_id
		WHERE jf.student_user_id = #{studentUserId}
		AND j.status = 20
	</select>

	<select id="findOtherJobsByCompany" resultMap="JobMap">
		SELECT * FROM jobs
		WHERE company_id = #{companyId}
		AND id != #{excludeJobId}
		AND status = 20
		ORDER BY updated_at DESC
		LIMIT #{limit}
	</select>

	<!-- 学生主页相关查询 -->
	<select id="findRankedJobs" resultMap="JobMap">
		SELECT j.*
		FROM jobs j
		LEFT JOIN (
			SELECT job_id, COUNT(*) as application_count
			FROM applications
			GROUP BY job_id
		) ac ON j.id = ac.job_id
		WHERE j.status = 20
		ORDER BY ac.application_count DESC, j.updated_at DESC
		LIMIT #{limit}
	</select>

	<select id="findRecentJobs" resultMap="JobMap">
		SELECT * FROM jobs
		WHERE status = 20
		<if test="jobTypeFilter != null and jobTypeFilter != ''">
			<choose>
				<when test="jobTypeFilter == '企业招聘'">
					AND work_nature = 2
				</when>
				<when test="jobTypeFilter == '实习招聘'">
					AND work_nature = 1
				</when>
				<when test="jobTypeFilter == '事业单位招聘'">
					<!-- 事业单位招聘可能需要根据type字段或其他字段判断，这里暂时不做筛选 -->
				</when>
			</choose>
		</if>
		ORDER BY created_at DESC
		LIMIT #{limit}
	</select>

	<insert id="batchInsertJobTags">
		INSERT INTO job_tags (job_id, tag_id)
		VALUES
		<foreach collection="tagIds" item="tagId" separator=",">
			(#{jobId}, #{tagId})
		</foreach>
	</insert>

	<delete id="deleteJobTagsByJobId">
		DELETE FROM job_tags WHERE job_id = #{jobId}
	</delete>
</mapper>



